# "我的清单"功能验收文档

## 功能说明

新增"我的清单"页面，让用户可以：
1. 查看自己创建的所有清单（OWNER）
2. 查看自己加入的所有清单（MEMBER）
3. 快速创建新清单
4. 通过邀请 Token 或链接加入清单

---

## 新增/修改的文件清单

### 后端文件（3个）

1. **新增**：`src/main/java/com/example/todolist/dto/MyListResponse.java`
   - 我的清单响应 DTO
   - 包含：token, title, role

2. **新增**：`src/main/java/com/example/todolist/controller/MyListsController.java`
   - 我的清单 API 控制器
   - 端点：`GET /api/my/lists`

3. **修改**：`src/main/java/com/example/todolist/controller/WebController.java`
   - 添加页面路由：`@GetMapping("/my-lists")`

### 前端文件（3个）

4. **新增**：`src/main/resources/templates/my-lists.html`
   - 我的清单页面（完整单页应用）

5. **修改**：`src/main/resources/templates/index.html`
   - 添加"我的清单"导航链接

6. **修改**：`src/main/resources/templates/list.html`
   - 添加"← 我的清单"返回链接

---

## 后端 API 详细说明

### GET /api/my/lists

**描述**：获取当前用户相关的所有清单

**请求头**：
```
X-User-Id: 123
```

**响应示例**：
```json
[
  {
    "token": "ABC123",
    "title": "我的工作清单",
    "role": "OWNER"
  },
  {
    "token": "XYZ789",
    "title": "团队任务",
    "role": "MEMBER"
  }
]
```

**错误处理**：
- `200 OK`: 成功，返回列表（可能为空数组）
- 用户不存在时返回空数组，不报错

---

## 前端 JS 功能说明

### getOrCreateUserId()
- 从 localStorage 获取 `todolist_user_id`
- 如果不存在，调用 `/api/users` 创建新用户
- 返回用户 ID

### fetchMyLists()
- 调用 `/api/my/lists` 获取清单列表
- 自动携带 `X-User-Id` 头
- 失败时显示错误提示

### renderOwnerSection(lists)
- 筛选 `role === 'OWNER'` 的清单
- 渲染到"我创建的"区域
- 显示：清单名称 + Token + 角色徽章 + 进入按钮

### renderMemberSection(lists)
- 筛选 `role === 'MEMBER'` 的清单
- 渲染到"我加入的"区域
- 显示：清单名称 + Token + 角色徽章 + 进入按钮

### createList()
- 读取输入框的清单名称
- 调用 `POST /api/lists` 创建清单
- 成功后刷新列表并跳转到清单详情页

### joinByTokenOrLink()
- 解析输入（支持完整链接或 Token）
- 提取 invite token
- 调用 `POST /api/lists/join` 加入清单
- 成功后刷新列表

---

## 验收步骤

### 测试 1: 新用户自动生成 userId

**步骤**：
1. 清除浏览器 localStorage（打开开发者工具 → Application → Local Storage → 删除 `todolist_user_id`）
2. 访问 http://localhost:8081/my-lists

**预期结果**：
- ✅ 页面正常加载
- ✅ 自动创建新用户（localStorage 中出现 `todolist_user_id`）
- ✅ 显示"您还没有创建任何清单"
- ✅ 显示"您还没有加入任何清单"

---

### 测试 2: 创建清单后出现在"我创建的"

**步骤**：
1. 在"我的清单"页面，输入清单名称"测试清单1"
2. 点击"创建"按钮

**预期结果**：
- ✅ 页面跳转到清单详情页
- ✅ 清单创建成功
- ✅ 返回"我的清单"页面
- ✅ "我创建的"区域显示"测试清单1"
- ✅ 角色显示为"所有者"
- ✅ Token 正确显示

---

### 测试 3: 用邀请 Token 加入后出现在"我加入的"

**步骤**：
1. 用户 A 创建清单（自动成为 OWNER）
2. 用户 A 生成邀请链接
3. 用户 B（新用户或清除 localStorage）打开 http://localhost:8081/my-lists
4. 用户 B 在"通过邀请加入"区域粘贴邀请链接或 Token
5. 点击"加入"按钮

**预期结果**：
- ✅ 提示"成功加入清单！"
- ✅ "我加入的"区域显示该清单
- ✅ 角色显示为"成员"
- ✅ Token 正确显示
- ✅ 可以点击"进入"按钮访问清单

---

### 测试 4: 点击"进入"按钮跳转到清单详情页

**步骤**：
1. 在"我的清单"页面
2. 点击任意清单的"进入"按钮

**预期结果**：
- ✅ 跳转到 `/lists/{token}` 页面
- ✅ 清单详情正常显示
- ✅ 可以正常添加、编辑待办事项

---

### 测试 5: 同时拥有创建和加入的清单

**步骤**：
1. 用户创建 2 个清单
2. 用户加入 3 个清单
3. 访问"我的清单"页面

**预期结果**：
- ✅ "我创建的"显示 2 个清单，徽章显示"2"
- ✅ "我加入的"显示 3 个清单，徽章显示"3"
- ✅ 所有清单的 Token 正确显示
- ✅ 所有清单的角色正确显示（OWNER/MEMBER）

---

### 测试 6: 从首页导航到"我的清单"

**步骤**：
1. 访问首页 http://localhost:8081/
2. 点击"我的清单"按钮

**预期结果**：
- ✅ 跳转到 `/my-lists` 页面
- ✅ 页面正常加载

---

### 测试 7: 从清单详情页返回"我的清单"

**步骤**：
1. 在任意清单详情页
2. 点击"← 我的清单"链接

**预期结果**：
- ✅ 跳转到 `/my-lists` 页面
- ✅ 所有清单正常显示

---

## 测试场景：完整工作流

### 场景 1: 新用户完整体验

**操作**：
1. 清除 localStorage
2. 访问首页，点击"我的清单"
3. 创建第一个清单"个人任务"
4. 点击"创建"后跳转到清单详情
5. 在详情页添加几个待办
6. 点击"← 我的清单"返回
7. 验证"个人任务"清单在"我创建的"中

**验收标准**：
- ✅ 用户自动创建
- ✅ 清单创建成功
- ✅ 角色为 OWNER
- ✅ 可以正常跳转和返回

---

### 场景 2: 多人协作

**操作**：
1. **用户 A**（主浏览器）：
   - 创建清单"团队项目"
   - 生成邀请链接

2. **用户 B**（无痕浏览器）：
   - 打开"我的清单"页面
   - 粘贴邀请链接
   - 点击"加入"
   - 验证清单出现在"我加入的"

3. **用户 A**：
   - 在"我的清单"页面验证"团队项目"仍在"我创建的"

**验收标准**：
- ✅ 用户 A 显示为 OWNER
- ✅ 用户 B 显示为 MEMBER
- ✅ 两人都可以访问清单
- ✅ 数据一致

---

### 场景 3: 邀请链接格式兼容

**测试输入**：

1. **完整链接（带 invite 参数）**：
   ```
   https://localhost:8081/lists/ABC123?invite=XYZ789
   ```
   ✅ 应能正确提取 `XYZ789` 并加入

2. **相对链接（带 invite 参数）**：
   ```
   /lists/ABC123?invite=XYZ789
   ```
   ✅ 应能正确提取 `XYZ789` 并加入

3. **只有 Token**：
   ```
   XYZ789
   ```
   ✅ 应能直接使用 `XYZ789` 加入

**验收标准**：
- ✅ 所有格式都能正确解析
- ✅ 加入成功后列表刷新
- ✅ 错误格式显示友好提示

---

## 错误处理测试

### 测试 1: 无效邀请 Token

**操作**：
1. 在"通过邀请加入"区域输入无效 Token（如 `INVALID123`）
2. 点击"加入"

**预期结果**：
- ✅ 显示错误提示："加入清单失败，请检查邀请链接或 Token"
- ✅ 列表不变

---

### 测试 2: 重复加入同一清单

**操作**：
1. 用户已经加入某个清单
2. 再次尝试使用同一邀请链接加入

**预期结果**：
- ✅ 显示错误提示（如"已是成员"或类似）
- ✅ 列表中该清单只显示一次

---

### 测试 3: 清单名称过长

**操作**：
1. 在创建清单时输入超长名称（>100 字符）

**预期结果**：
- ✅ 后端截断到 100 字符（数据库约束）
- ✅ 或前端提前验证并提示

---

## 性能测试

### 测试 1: 大量清单

**操作**：
1. 用户创建/加入 50+ 个清单
2. 打开"我的清单"页面

**预期结果**：
- ✅ 页面正常加载（可能稍慢）
- ✅ 所有清单正确显示
- ✅ 分组计数正确

---

## 兼容性测试

### 浏览器兼容性

测试以下浏览器：
- ✅ Chrome/Edge（最新版）
- ✅ Firefox（最新版）
- ✅ Safari（最新版）

**验收标准**：
- ✅ 页面正常显示
- ✅ 功能正常工作
- ✅ localStorage 正常读写

---

## 移动端测试

**设备**：手机/平板（375px - 430px）

**验收标准**：
- ✅ 响应式布局正常
- ✅ 按钮易于点击（至少 44x44px）
- ✅ 文字大小合适
- ✅ 无横向滚动

---

## 安全测试

### 测试 1: X-User-Id 注入

**操作**：
1. 修改请求头中的 `X-User-Id` 为其他用户的 ID
2. 调用 `/api/my/lists`

**预期结果**：
- ✅ 只返回该用户关联的清单
- ✅ 不能访问其他用户的清单

---

## 数据验证

### 数据库验证

```sql
-- 验证 list_member 表中有正确的数据
SELECT lm.id, l.title, lm.role, u.username
FROM list_member lm
JOIN todo_list l ON lm.list_id = l.id
JOIN "user" u ON lm.user_id = u.id
ORDER BY lm.created_at DESC;
```

**验收标准**：
- ✅ 所有创建清单的用户都有 OWNER 角色
- ✅ 所有加入清单的用户都有 MEMBER 角色
- ✅ 没有重复的 list_id + user_id 组合

---

## 完整验收清单

- [ ] 新用户打开 /my-lists 自动生成 userId
- [ ] 空状态显示友好提示
- [ ] 创建清单后出现在"我创建的"
- [ ] 加入清单后出现在"我加入的"
- [ ] Token 正确显示
- [ ] 角色正确显示（OWNER/MEMBER）
- [ ] 点击"进入"按钮跳转到清单详情页
- [ ] 清单详情页可以正常使用
- [ ] 从首页可以导航到"我的清单"
- [ ] 从清单详情页可以返回"我的清单"
- [ ] 支持多种邀请链接格式
- [ ] 错误提示友好清晰
- [ ] 移动端响应式正常
- [ ] 多用户协作正常
- [ ] 数据持久化正常

---

## 快速验收脚本

```bash
# 1. 启动应用
cd /d/develop/project/todolist
mvn spring-boot:run

# 2. 打开浏览器
# Chrome: http://localhost:8081/my-lists

# 3. 清除 localStorage（测试新用户）
# 开发者工具 → Application → Local Storage → 删除 todolist_user_id

# 4. 执行验收测试（参考上述步骤）
```

---

## 已知限制

1. **未实现分页**：如果清单数量很多（>100），可能会影响性能
2. **未实现搜索**：不能按清单名称搜索
3. **未实现排序**：按创建时间排序，不能自定义排序
4. **未实现最近访问**：不记录访问历史

这些功能可以在后续版本中根据需求添加。

---

## 后续优化建议

1. **性能优化**：添加分页（每页 20 条）
2. **用户体验**：添加搜索和排序功能
3. **数据统计**：显示每个清单的待办完成数
4. **快捷操作**：在列表中直接删除清单（OWNER）
5. **收藏功能**：标记常用清单
