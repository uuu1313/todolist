<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共享待办清单 - 简单快速的协作工具</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" type="image/x-icon" sizes="16x16" href="/icons/favicon-16.ico">
    <link rel="icon" type="image/x-icon" sizes="32x32" href="/icons/favicon-32.ico">
</head>
<body>
    <div class="home-page">
        <div class="home-header">
            <h1 class="home-title">共享待办清单</h1>
            <p class="home-subtitle">简单、快速的协作工具</p>
        </div>

        <button id="createListBtn" class="home-button">
            创建新清单
        </button>

        <div style="margin-top: 1rem;">
            <a href="/my-lists" style="display: inline-block; padding: 0.75rem 1.5rem; background: white; color: var(--primary-color); text-decoration: none; border-radius: var(--radius-md); font-weight: 600; transition: all 0.2s ease; border: 2px solid var(--primary-color);">
                我的清单
            </a>
        </div>

        <div id="result" style="margin-top: 2rem; display: none;" class="hidden">
            <div style="background: var(--surface); padding: var(--spacing-lg); border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                <h3 style="color: var(--success-color); margin-bottom: var(--spacing-md); font-size: 1.25rem;">
                    清单已创建！
                </h3>
                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                    Token: <strong id="token" style="color: var(--text-primary); font-family: monospace; font-size: 1.125rem;"></strong>
                </p>
                <p style="margin-top: var(--spacing-lg);">
                    <a id="listLink" href=""
                       style="display: inline-block; padding: var(--spacing-md) var(--spacing-xl); background: var(--primary-color); color: white; text-decoration: none; border-radius: var(--radius-md); font-weight: 600; transition: all 0.2s ease;">
                        查看清单
                    </a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==================== V2-B 用户身份管理 ====================
        let currentUserId = null;

        // 获取或创建用户（带自愈机制）
        async function ensureUser() {
            let userId = localStorage.getItem('todolist_user_id');

            // V2-B 自愈机制：验证用户是否存在
            if (userId) {
                try {
                    const response = await fetch(`/api/users/${userId}`);
                    if (!response.ok) {
                        // 用户不存在（后端重启/清库后），重新创建
                        console.log('User not found, recreating...');
                        userId = null;
                    }
                } catch (error) {
                    console.error('Error validating user:', error);
                    userId = null;
                }
            }

            // 如果没有用户 ID 或验证失败，创建新用户
            if (!userId) {
                try {
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    });
                    const user = await response.json();
                    userId = user.id;
                    localStorage.setItem('todolist_user_id', userId);
                    console.log('User created:', userId);
                } catch (error) {
                    console.error('Error creating user:', error);
                }
            }

            currentUserId = userId;
            return userId;
        }

        // 拦截 fetch 请求，自动添加 X-User-Id 头
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            if (currentUserId) {
                options.headers = options.headers || {};
                options.headers['X-User-Id'] = currentUserId;
            }
            return originalFetch(url, options);
        };

        // 页面加载时确保用户存在
        document.addEventListener('DOMContentLoaded', async () => {
            await ensureUser();
        });

        // ==================== 创建清单逻辑 ====================
        document.getElementById('createListBtn').addEventListener('click', async () => {
            const btn = document.getElementById('createListBtn');
            const originalText = btn.textContent;

            // 显示加载状态
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> 创建中...';

            try {
                const response = await fetch('/api/lists', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('创建失败');
                }

                const data = await response.json();
                document.getElementById('token').textContent = data.token;
                document.getElementById('listLink').href = '/lists/' + data.token;
                document.getElementById('result').style.display = 'block';
                document.getElementById('result').classList.remove('hidden');

                // 隐藏创建按钮
                btn.style.display = 'none';

                showToast('清单创建成功！', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('创建清单失败，请稍后重试', 'error');

                // 恢复按钮状态
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // 3秒后自动移除
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
